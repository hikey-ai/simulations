<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Sindoor: A Tale of Valor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #000; 
            color: #fff; 
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #infoPanel { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            padding: 20px; 
            background: rgba(10, 20, 40, 0.85); 
            border: 1px solid #FF9933;
            border-radius: 12px; 
            max-width: 400px; 
            max-height: 80vh;
            overflow-y: auto;
            z-index: 100; 
            box-shadow: 0 0 15px rgba(255, 153, 51, 0.5);
        }
        #sceneTitle { 
            font-size: 26px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #FF9933; /* Saffron */
            border-bottom: 2px solid #FF9933;
            padding-bottom: 10px;
        }
        #sceneText { 
            font-size: 16px; 
            line-height: 1.6; 
            margin-bottom: 10px;
        }
        .text-paragraph {
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInPara 0.5s forwards;
        }
        @keyframes fadeInPara {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        #twitterFeed { 
            margin-top: 20px; 
            border-top: 1px solid #557799; 
            padding-top: 15px; 
        }
        .tweet { 
            font-size: 14px; 
            margin-bottom: 12px; 
            padding: 10px; 
            background: rgba(30, 50, 80, 0.7); 
            border-radius: 6px; 
            border-left: 3px solid #FF9933;
        }
        .tweet strong { color: #66AADD; } /* Lighter blue for user names */
        .tweet .sentiment-pride { color: #4CAF50; font-weight: bold; } /* Green for pride */
        .tweet .sentiment-concern { color: #FFC107; font-weight: bold; } /* Amber for concern */
        .tweet .sentiment-critical { color: #F44336; font-weight: bold; } /* Red for critical */
        
        #nextButton { 
            position: absolute; 
            bottom: 30px; 
            right: 30px; 
            padding: 12px 25px; 
            background: linear-gradient(145deg, #FF9933, #E67E22); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold;
            cursor: pointer; 
            z-index: 100; 
            box-shadow: 0 0 10px rgba(255, 153, 51, 0.7);
            transition: background 0.3s, transform 0.1s;
        }
        #nextButton:hover {
            background: linear-gradient(145deg, #E67E22, #D35400);
            transform: scale(1.05);
        }
        #nextButton:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }
        #statsPanel { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            padding: 15px; 
            background: rgba(10, 20, 40, 0.85); 
            border: 1px solid #138808; /* Green */
            border-radius: 8px; 
            z-index: 100; 
            display: none;
            box-shadow: 0 0 15px rgba(19, 136, 8, 0.5);
        }
        .statItem { font-size: 15px; margin-bottom: 8px; color: #FFFFFF; }
        .statItem strong { color: #FF9933; }

        #strikeMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            color: #FFD700; /* Gold */
            padding: 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            z-index: 101;
            display: none;
            text-shadow: 0 0 5px #000;
        }
        #canvasContainer {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- Mobile Styles --- */
        @media (max-width: 768px) {
            #infoPanel {
                top: 10px;
                left: 5%;
                right: 5%;
                width: 90%; /* Adjusted from auto for clarity */
                max-width: none;
                padding: 15px;
                max-height: 65vh;
            }

            #sceneTitle {
                font-size: 20px;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }

            #sceneText {
                font-size: 14px;
                line-height: 1.5;
            }
            .text-paragraph {
                margin-bottom: 8px;
            }

            #twitterFeed {
                margin-top: 15px;
                padding-top: 10px;
            }

            .tweet {
                font-size: 12px;
                padding: 8px;
                margin-bottom: 10px;
            }

            #statsPanel {
                top: auto;
                bottom: 80px; /* Position above nextButton */
                left: 10px; 
                right: auto;
                width: auto;
                max-width: 45%; /* Can take a bit more width if needed */
                padding: 10px;
                font-size: 12px;
                box-shadow: 0 0 10px rgba(19, 136, 8, 0.4);
            }
            .statItem {
                font-size: 13px;
                margin-bottom: 6px;
            }

            #nextButton {
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: 80%; 
                max-width: 300px; 
                padding: 15px 10px; /* Adjusted padding */
                font-size: 16px;
            }

            #strikeMessage {
                font-size: 20px;
                padding: 10px;
                width: 80%;
                text-align: center;
            }
        }

        @media (max-width: 480px) { /* Specific adjustments for very small screens */
            #infoPanel {
                padding: 10px;
                max-height: 60vh; /* Slightly less height to ensure button visibility */
            }
            #sceneTitle {
                font-size: 18px;
            }
            #sceneText {
                font-size: 13px;
            }
            .tweet {
                font-size: 11px;
            }
            #statsPanel {
                font-size: 11px;
                padding: 8px;
                bottom: 90px; /* Raise slightly if button padding increased */
                max-width: 50%;
            }
            .statItem {
                font-size: 12px;
            }
            #nextButton {
                font-size: 15px;
                padding: 12px 10px; /* Further adjust padding */
                width: 90%;
            }
             #strikeMessage {
                font-size: 18px;
            }
        }

    </style>
</head>
<body>
    <div id="container">
        <div id="canvasContainer"></div>

        <div id="infoPanel">
            <div id="sceneTitle"></div>
            <div id="sceneText"></div>
            <div id="twitterFeed" style="display:none;"></div>
        </div>

        <div id="statsPanel">
            <div class="statItem">Rupee vs USD: <strong>84.66 (Dip)</strong></div>
            <div class="statItem">Pakistan Stock Market: <strong>-5.5%</strong></div>
            <div class="statItem">#OperationSindoor Mentions: <strong>1.2M+</strong></div>
        </div>

        <div id="strikeMessage"></div>

        <button id="nextButton">Start Simulation</button>
    </div>

    <script>
        let scene, camera, renderer;
        let currentSceneIndex = -1;
        const scenesData = [];
        let jets = [], targets = [], explosions = [];
        let strikeAnimationData = {
            targetsHit: 0,
            totalTargets: 9,
            jetSpeed: 0.05, 
            currentTargetIndex: 0,
            jetsLaunched: 0,
            phase: 'idle', 
            strikeMessageTimeout: null
        };

        const infoPanel = document.getElementById('infoPanel');
        const sceneTitleEl = document.getElementById('sceneTitle');
        const sceneTextEl = document.getElementById('sceneText');
        const twitterFeedEl = document.getElementById('twitterFeed');
        const statsPanelEl = document.getElementById('statsPanel');
        const nextButton = document.getElementById('nextButton');
        const strikeMessageEl = document.getElementById('strikeMessage');
        const canvasContainer = document.getElementById('canvasContainer');

        // --- SCENE DEFINITIONS ---
        scenesData.push({
            title: "Operation Sindoor: A Tale of Valor",
            text: ["Welcome. This simulation recounts India's decisive response to terror, known as #OperationSindoor.", "Click 'Begin Story' to witness this tale of valor."],
            buttonText: "Begin Story",
            setup: () => {
                camera.position.z = 5;
                const starGeometry = new THREE.BufferGeometry();
                const starMaterial = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.02 });
                const starVertices = [];
                const numStars = window.innerWidth < 768 ? 1500 : 5000; // Mobile optimization
                for (let i = 0; i < numStars; i++) {
                    const x = (Math.random() - 0.5) * 200;
                    const y = (Math.random() - 0.5) * 200;
                    const z = (Math.random() - 0.5) * 200;
                    starVertices.push(x, y, z);
                }
                starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                const stars = new THREE.Points(starGeometry, starMaterial);
                stars.name = "background_stars"; // Naming for easier cleanup
                scene.add(stars);
            }
        });

        scenesData.push({
            title: "Pahalgam Attack: April 22, 2025",
            text: [
                "A date seared into memory. A cowardly act of terror strikes Pahalgam, a peaceful haven.",
                "25 innocent Indian civilians and one Nepali national tragically lose their lives at the hands of Lashkar-e-Taiba, Jaish-e-Mohammed, and Hizbul Mujahideen.",
                "The nation is engulfed in grief. Tears fall, but India's resolve to protect its people and deliver justice only strengthens."
            ],
            buttonText: "India's Resolve",
            setup: () => {
                scene.background = new THREE.Color(0x101020);
            }
        });

        scenesData.push({
            title: "The Decision: Operation Sindoor",
            text: [
                "India will not stand idle. A swift, decisive, and righteous response is meticulously planned: #OperationSindoor.",
                "Named for 'Sindoor' – the sacred vermilion powder, a profound symbol of marital honor, and in this context, a vow to avenge the widows of Pahalgam.",
                "The mission: Neutralize nine key terrorist launchpads and training camps across Pakistan and PoK.",
                "The rules of engagement are clear: target only male terrorists. Spare women, children, and civilians. Uphold Dharma, even in retribution."
            ],
            buttonText: "Launch Operation",
            setup: () => {
                scene.background = new THREE.Color(0x102030);
                const indiaGeo = new THREE.SphereGeometry(1.5, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2); 
                const indiaMat = new THREE.MeshPhongMaterial({ color: 0x004488, emissive: 0x002244 });
                const indiaMesh = new THREE.Mesh(indiaGeo, indiaMat);
                indiaMesh.rotation.x = -Math.PI / 4;
                indiaMesh.name = "map_element";
                scene.add(indiaMesh);
            }
        });

        scenesData.push({
            title: "The Strike: May 7, 2025 - #OperationSindoor",
            text: [
                "Under the cover of night, Indian Air Force jets streak across the border. Their mission: surgical precision, maximum impact on terror infrastructure.",
                "Nine critical terrorist sites are targeted. The terrorists spared women in Pahalgam but widowed many; India's response targets the perpetrators.",
                "Pilots navigate hostile territory, their courage unwavering. The nation holds its breath."
            ],
            buttonText: "Executing Strikes...",
            setup: () => {
                scene.background = new THREE.Color(0x050510); 
                const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x223322, roughness: 0.8, metalness: 0.2 });
                const groundPlane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), groundMaterial);
                groundPlane.rotation.x = -Math.PI / 2;
                groundPlane.position.y = -5;
                groundPlane.name = "ground";
                scene.add(groundPlane);

                camera.position.set(0, 15, 25); 
                camera.lookAt(0, 0, 0);

                const targetMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000, emissive: 0x550000 });
                for (let i = 0; i < strikeAnimationData.totalTargets; i++) {
                    const target = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 16), targetMaterial);
                    target.position.set(
                        (Math.random() - 0.5) * 30,
                        -4.5,
                        (Math.random() - 0.5) * 30 - 5 
                    );
                    target.name = `target_${i}`;
                    targets.push(target);
                    scene.add(target);
                }
                strikeAnimationData.phase = 'jets_launching';
                strikeAnimationData.targetsHit = 0;
                strikeAnimationData.currentTargetIndex = 0;
                strikeAnimationData.jetsLaunched = 0;
                nextButton.disabled = true; 
            },
            animate: strikeSceneAnimate,
            cleanup: () => { 
                const ground = scene.getObjectByName("ground");
                if (ground) scene.remove(ground);
                jets.forEach(j => scene.remove(j.mesh)); // remove jet mesh specifically
                jets = [];
                targets.forEach(t => scene.remove(t));
                targets = [];
                explosions.forEach(e => e.dispose()); 
                explosions = [];
                strikeAnimationData.phase = 'idle';
                camera.position.set(0,0,5); 
                camera.lookAt(0,0,0);
            }
        });

        scenesData.push({
            title: "The Echoes: Nation & World React",
            text: [
                "SUCCESS! All targets neutralized. #OperationSindoor trends worldwide with over 1.2 million mentions! Visuals of smoking terror camps fill the screens.",
                "A wave of national pride sweeps India. 70% of online posts laud the Indian Army and PM Modi for the 'slap on terror'.",
                "Maharashtra CM Devendra Fadnavis praises 'surgical precision'. Union Minister Amit Shah tweets emojis of biceps and tricolors.",
            ],
            buttonText: "Global Impact",
            setup: () => {
                scene.background = new THREE.Color(0x1a365d); 
                twitterFeedEl.style.display = 'block';
                populateTwitterFeed([
                    { user: "ProudPatriot🇮🇳", text: "INCREDIBLE! #OperationSindoor executed FLAWLESSLY! Our forces make us proud! Jai Hind! A new, strong India! 💪", sentiment: "pride" },
                    { user: "AnalystGlobal", text: "India's airstrikes spark international debate. Rupee at 84.66 vs USD. Pak stock market crashes 5.5%. Calls for diplomacy rise. #Geopolitics", sentiment: "neutral" },
                    { user: "PeaceSeeker25", text: "While understanding the retaliation, worried about escalation. Pakistan reports ceasefire violations. Hope cooler heads prevail. 🙏 #OperationSindoor", sentiment: "concern" },
                    { user: "Devendra_Fadnavis_Official", text: "Salute the Indian Air Force for their surgical precision in #OperationSindoor. India will not tolerate terror on its soil. #NewIndia", sentiment: "pride" },
                ]);
                statsPanelEl.style.display = 'block';

                const flagMaterial = new THREE.ShaderMaterial({
                    uniforms: { time: { value: 0 } },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        varying vec2 vUv;
                        uniform float time;
                        void main() {
                            vec3 saffron = vec3(1.0, 0.6, 0.2); 
                            vec3 white = vec3(1.0, 1.0, 1.0);
                            vec3 green = vec3(0.07, 0.53, 0.03); 
                            
                            float y = vUv.y + sin(vUv.x * 10.0 + time * 2.0) * 0.03; 
                            
                            vec3 color = white;
                            if (y > 0.66) color = saffron;
                            else if (y < 0.33) color = green;
                            
                            float dist = distance(vUv, vec2(0.5, 0.5));
                            if (y > 0.33 && y < 0.66 && dist < 0.15 && dist > 0.13) {
                                color = vec3(0.0, 0.0, 0.5); 
                            }
                             if (y > 0.33 && y < 0.66 && dist < 0.02) {
                                color = vec3(0.0, 0.0, 0.5); 
                            }
                            gl_FragColor = vec4(color, 1.0);
                        }
                    `
                });
                const flagPlaneSizeX = window.innerWidth < 768 ? 6 : 10; // Mobile optimization
                const flagPlaneSizeY = window.innerWidth < 768 ? 3.6 : 6; // Mobile optimization
                const flagPlane = new THREE.Mesh(new THREE.PlaneGeometry(flagPlaneSizeX, flagPlaneSizeY), flagMaterial);
                flagPlane.position.z = -2; 
                flagPlane.name = "animated_flag";
                scene.add(flagPlane);
            },
            animate: (time) => {
                const flag = scene.getObjectByName("animated_flag");
                if (flag && flag.material.uniforms) flag.material.uniforms.time.value = time * 0.001;
            },
            cleanup: () => {
                 const flag = scene.getObjectByName("animated_flag");
                 if(flag) scene.remove(flag);
            }
        });

        scenesData.push({
            title: "Critiques and Concerns",
            text: [
                "However, not all voices joined the chorus of celebration.",
                "A minority (10%) offered feminist critiques, questioning the patriarchal undertones of the name 'Sindoor', arguing it frames women primarily as widows rather than active agents.",
                "Others dismissed the operation as 'tokenism' or a 'Modi stunt', demanding a more comprehensive long-term strategy against terror.",
                "Concerns about escalation persisted, with Pakistan's propaganda machine churning out counter-narratives and reports of ceasefire violations along the LoC."
            ],
            buttonText: "India's Unwavering Message",
            setup: () => {
                twitterFeedEl.style.display = 'block'; 
                populateTwitterFeed([ 
                    { user: "FeministVoice", text: "Why #OperationSindoor? Is a woman's honor only tied to her marital status? This naming is patriarchal and regressive. #GenderCritique", sentiment: "critical" },
                    { user: "StrategicMind", text: "Good strike, but what's the long game? #OperationSindoor feels like Operation Selfie - looks cool, but does it change fundamental realities? Need strategy, not just spectacle.", sentiment: "critical" },
                    { user: "GlobalObserver", text: "Qatar and other nations urge restraint. The international community is watching closely. #DiplomacyFirst", sentiment: "concern" }
                ]);
                 statsPanelEl.style.display = 'block';
            },
            cleanup: () => {
                twitterFeedEl.innerHTML = ''; 
                twitterFeedEl.style.display = 'none';
                statsPanelEl.style.display = 'none';
            }
        });

        scenesData.push({
            title: "India's Message: Valor and Vigilance",
            text: [
                "Despite diverse reactions, #OperationSindoor delivered a powerful message: India will not hesitate to act decisively to protect its sovereignty and its citizens.",
                "It was a testament to the valor of the Indian Armed Forces, a high-density tale of courage that resonated across the nation and the world.",
                "The skies were painted red with justice. While debates continue, India stands united and vigilant against the scourge of terrorism.",
                "JAI HIND! 🇮🇳"
            ],
            buttonText: "End Simulation",
            setup: () => {
                scene.background = new THREE.Color(0x000000); 
                const textureLoader = new THREE.TextureLoader();
                textureLoader.load('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDgwIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI4IiBmaWxsPSIjMDAwMDgwIi8+PGcgc3Ryb2tlPSIjMDAwMDgwIiBzdHJva2Utd2lkdGg9IjIiPjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iNTAiIHkyPSI1Ii8+PGxpbmUgeDE9IjUwIiB5MT0iNTAiIHgyPSI1MCIgeTI9Ijk1Ii8+PGxpbmUgeDE9IjUwIiB5MT0iNTAiIHgyPSI1IiB5Mj0iNTAiLz48bGluZSB4MT0iNTAiIHkxPSI1MCIgeDI9Ijk1IiB5Mj0iNTAiLz48bGluZSB4MT0iNTAiIHkxPSI1MCIgeDI9Ijc4LjMiIHkyPSIxNS41Ii8+PGxpbmUgeDE9IjUwIiB5MT0iNTAiIHgyPSIyMS43IiB5Mj0iODQuNSIvPjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iODQuNSIgeTI9IjIxLjciLz48bGluZSB4MT0iNTAiIHkxPSI1MCIgeDI9IjE1LjUiIHkyPSI3OC4zIi8+PGxpbmUgeDE9IjUwIiB5MT0iNTAiIHgyPSI5Mi40IiB5Mj0iMzUuMiIvPjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iNy42IiB5Mj0iNjQuOCIvPjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iNjQuOCIgeTI9IjkuMiIvPjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iMzUuMiIgeTI9IjkxLjYiLz48L2c+PC9zdmc+', (texture) => {
                    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
                    const planeSize = window.innerWidth < 768 ? 3.5 : 5; // Mobile optimization
                    const geometry = new THREE.PlaneGeometry(planeSize, planeSize);
                    const chakra = new THREE.Mesh(geometry, material);
                    chakra.name = "chakra_final";
                    scene.add(chakra);
                });
            },
            cleanup: () => {
                const chakra = scene.getObjectByName("chakra_final");
                if(chakra) scene.remove(chakra);
            }
        });

        // --- INITIALIZATION AND MAIN LOOP ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            canvasContainer.appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize, false);
            nextButton.addEventListener('click', loadNextScene);

            loadNextScene(); 
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            // Could re-evaluate scene element sizes here if needed, but initial setup based on width is often enough.
        }

        let paragraphTimeout;
        function displayTextSequentially(paragraphs, index = 0) {
            if (index < paragraphs.length) {
                const p = document.createElement('p');
                p.className = 'text-paragraph';
                p.textContent = paragraphs[index];
                p.style.animationDelay = `${index * 0.05}s`; // Faster stagger
                sceneTextEl.appendChild(p);
                const delay = paragraphs[index].length * 30 + 500; // Delay based on text length, min 0.5s
                paragraphTimeout = setTimeout(() => displayTextSequentially(paragraphs, index + 1), Math.max(1000, delay)); 
            } else {
                 if (scenesData[currentSceneIndex].animate || strikeAnimationData.phase !== 'idle') {
                    // Button handled by animation
                 } else {
                    nextButton.disabled = false;
                 }
            }
        }

        function loadNextScene() {
            clearTimeout(paragraphTimeout); 
            nextButton.disabled = true; 

            if (currentSceneIndex >= 0 && scenesData[currentSceneIndex].cleanup) {
                scenesData[currentSceneIndex].cleanup();
            }
            
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child.name === "background_stars" || 
                    child.name === "map_element" || 
                    child.name === "chakra_final" || 
                    child.name === "animated_flag" || 
                    child.name === "ground" ||
                    (child.type === "Points" && !child.name) ) { // Catch unnamed generic points if any
                    objectsToRemove.push(child);
                } else if (child.name && (child.name.startsWith("jet_") || child.name.startsWith("target_"))) {
                    objectsToRemove.push(child);
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));
            // Ensure arrays are also cleared
            jets.forEach(j => { if(j.mesh) scene.remove(j.mesh); }); // Defensive removal
            jets = []; 
            targets.forEach(t => scene.remove(t));
            targets = []; 
            explosions.forEach(e => e.dispose());
            explosions = [];


            currentSceneIndex++;
            if (currentSceneIndex >= scenesData.length) {
                // End of simulation, behavior depends on desired outcome (e.g., reload, specific end screen)
                // For now, just go to first scene to allow restart
                alert("Simulation Complete. Restarting.");
                window.location.reload(); // Simple restart
                return; 
            }

            const currentSceneData = scenesData[currentSceneIndex];

            sceneTitleEl.textContent = currentSceneData.title;
            sceneTextEl.innerHTML = ''; 
            
            displayTextSequentially(currentSceneData.text);

            nextButton.textContent = currentSceneData.buttonText;

            twitterFeedEl.style.display = 'none';
            twitterFeedEl.innerHTML = ''; 
            statsPanelEl.style.display = 'none';
            strikeMessageEl.style.display = 'none';

            if (currentSceneData.setup) {
                currentSceneData.setup();
            }
            
            let totalTextTime = 0;
            currentSceneData.text.forEach(para => { totalTextTime += Math.max(1000, para.length * 30 + 500); });

            if (!currentSceneData.animate && currentSceneIndex !== 3) { 
                 setTimeout(() => { if(strikeAnimationData.phase === 'idle') nextButton.disabled = false; }, totalTextTime + 200);
            } else if (currentSceneIndex === 3) { 
                // Button handled by strikeSceneAnimate
            } else {
                nextButton.disabled = false; 
            }

            if(currentSceneData.buttonText === "End Simulation"){
                nextButton.onclick = () => {
                     alert("Simulation Ended. Thank you for participating. Jai Hind! 🇮🇳");
                     window.location.reload(); // Or navigate to another page
                };
            } else {
                nextButton.onclick = loadNextScene;
            }
            
            if (currentSceneIndex !== 3) {
                 strikeAnimationData.phase = 'idle';
                 strikeAnimationData.targetsHit = 0;
                 strikeAnimationData.currentTargetIndex = 0;
                 strikeAnimationData.jetsLaunched = 0;
            }
        }

        function populateTwitterFeed(tweets) {
            twitterFeedEl.innerHTML = ''; 
            tweets.forEach(tweetData => {
                const tweetDiv = document.createElement('div');
                tweetDiv.className = 'tweet';
                let sentimentClass = '';
                if (tweetData.sentiment === 'pride') sentimentClass = 'sentiment-pride';
                else if (tweetData.sentiment === 'concern') sentimentClass = 'sentiment-concern';
                else if (tweetData.sentiment === 'critical') sentimentClass = 'sentiment-critical';

                tweetDiv.innerHTML = `<strong>${tweetData.user}:</strong> ${tweetData.text} ${sentimentClass ? `<span class="${sentimentClass}">(${tweetData.sentiment.toUpperCase()})</span>` : ''}`;
                twitterFeedEl.appendChild(tweetDiv);
            });
        }
        
        function createJet() {
            const jetBodyGeo = new THREE.ConeGeometry(0.2, 1.5, 4); 
            jetBodyGeo.rotateX(Math.PI / 2); 
            const jetMaterial = new THREE.MeshPhongMaterial({ color: 0x777788, emissive:0x111122 });
            const jetMesh = new THREE.Mesh(jetBodyGeo, jetMaterial);
            const jetGroup = new THREE.Group();
            jetGroup.add(jetMesh);
            return jetGroup;
        }

        function createExplosion(position) {
            const explosion = {
                particles: [],
                maxLife: 1.5, 
                startTime: clock.getElapsedTime(),
                origin: position.clone()
            };

            const particleCountBase = window.innerWidth < 768 ? 20 : 40; // Mobile optimization
            const particleCountRandom = window.innerWidth < 768 ? 20 : 40; // Mobile optimization
            const particleCount = particleCountBase + Math.random() * particleCountRandom;

            const particleMaterial = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                sizeAttenuation: true
            });

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const colors = [];
            const velocities = [];
            const colorChoices = [new THREE.Color(0xffd700), new THREE.Color(0xffa500), new THREE.Color(0xff4500), new THREE.Color(0x808080)];

            for (let i = 0; i < particleCount; i++) {
                vertices.push(0,0,0); 
                const color = colorChoices[Math.floor(Math.random() * colorChoices.length)];
                colors.push(color.r, color.g, color.b);
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                const speed = Math.random() * 5 + 2; 
                velocities.push(
                    speed * Math.sin(theta) * Math.cos(phi),
                    speed * Math.sin(theta) * Math.sin(phi),
                    speed * Math.cos(theta)
                );
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const points = new THREE.Points(geometry, particleMaterial);
            points.position.copy(position);
            scene.add(points);
            
            explosion.mesh = points;
            explosion.velocities = velocities;
            explosion.geometry = geometry; 

            explosion.dispose = () => {
                if(points.parent) scene.remove(points); // Check parent before removing
                geometry.dispose();
                particleMaterial.dispose();
            }
            explosions.push(explosion);
        }
        
        const clock = new THREE.Clock();

        function strikeSceneAnimate() {
            const deltaTime = clock.getDelta(); 

            for (let i = explosions.length - 1; i >= 0; i--) {
                const expl = explosions[i];
                const elapsedTime = clock.getElapsedTime() - expl.startTime;
                const lifeRatio = elapsedTime / expl.maxLife;

                if (lifeRatio > 1) {
                    expl.dispose();
                    explosions.splice(i, 1);
                    continue;
                }

                const positions = expl.geometry.attributes.position.array;
                for (let j = 0; j < positions.length / 3; j++) {
                    positions[j * 3] += expl.velocities[j * 3] * deltaTime * (1 - lifeRatio); 
                    positions[j * 3 + 1] += expl.velocities[j * 3 + 1] * deltaTime * (1 - lifeRatio);
                    positions[j * 3 + 2] += expl.velocities[j * 3 + 2] * deltaTime * (1 - lifeRatio);
                }
                expl.geometry.attributes.position.needsUpdate = true;
                expl.mesh.material.opacity = 1 - lifeRatio;
                expl.mesh.material.size = 0.5 * (1-lifeRatio) + 0.1; 
            }


            if (strikeAnimationData.phase === 'jets_launching') {
                if (strikeAnimationData.jetsLaunched < strikeAnimationData.totalTargets && jets.length < 3) { 
                    const jet = createJet();
                    jet.position.set((Math.random() - 0.5) * 10, 5, 20); 
                    if(targets[strikeAnimationData.jetsLaunched]) { // Ensure target exists
                       jet.lookAt(targets[strikeAnimationData.jetsLaunched].position);
                       jet.name = `jet_${strikeAnimationData.jetsLaunched}`;
                       jets.push({mesh: jet, targetIndex: strikeAnimationData.jetsLaunched});
                       scene.add(jet);
                       strikeAnimationData.jetsLaunched++;
                    } else {
                        // This case implies targets array might be prematurely empty or index out of bounds
                        // Potentially end phase if no more valid targets to assign.
                        strikeAnimationData.phase = 'all_cleared'; // Or some error state
                    }
                }
                if (strikeAnimationData.jetsLaunched >= strikeAnimationData.totalTargets && jets.length === 0) {
                    strikeAnimationData.phase = 'all_cleared'; 
                } else if (jets.length > 0) {
                     strikeAnimationData.phase = 'jets_moving';
                }
            }
            
            if (strikeAnimationData.phase === 'jets_moving') {
                for (let i = jets.length - 1; i >= 0; i--) {
                    const jetObj = jets[i];
                    const jetMesh = jetObj.mesh;
                    
                    if (!targets[jetObj.targetIndex]) { // Target might have been removed or undefined
                        if (jetMesh.parent) scene.remove(jetMesh);
                        jets.splice(i,1);
                        continue;
                    }
                    const targetMesh = targets[jetObj.targetIndex];


                    if (!targetMesh.visible) { 
                         if (jetMesh.parent) scene.remove(jetMesh);
                         jets.splice(i,1);
                         continue;
                    }

                    const direction = new THREE.Vector3().subVectors(targetMesh.position, jetMesh.position).normalize();
                    jetMesh.position.addScaledVector(direction, strikeAnimationData.jetSpeed * 100 * deltaTime); 
                    jetMesh.lookAt(targetMesh.position);

                    if (jetMesh.position.distanceTo(targetMesh.position) < 1.5) { 
                        createExplosion(targetMesh.position);
                        targetMesh.visible = false; 
                        if (jetMesh.parent) scene.remove(jetMesh); 
                        jets.splice(i,1);
                        
                        strikeAnimationData.targetsHit++;
                        strikeMessageEl.textContent = `Target ${strikeAnimationData.targetsHit}/${strikeAnimationData.totalTargets} Neutralized!`;
                        strikeMessageEl.style.display = 'block';
                        
                        clearTimeout(strikeAnimationData.strikeMessageTimeout);
                        strikeAnimationData.strikeMessageTimeout = setTimeout(() => {
                            strikeMessageEl.style.display = 'none';
                        }, 1500);

                        if (strikeAnimationData.targetsHit >= strikeAnimationData.totalTargets) {
                            strikeAnimationData.phase = 'all_cleared';
                        } else {
                             if (strikeAnimationData.jetsLaunched < strikeAnimationData.totalTargets && jets.length < 3) {
                                strikeAnimationData.phase = 'jets_launching'; 
                            }
                        }
                    }
                }
                 if (jets.length === 0 && strikeAnimationData.targetsHit < strikeAnimationData.totalTargets && strikeAnimationData.jetsLaunched < strikeAnimationData.totalTargets) {
                    strikeAnimationData.phase = 'jets_launching'; 
                }
            }

            if (strikeAnimationData.phase === 'all_cleared') {
                strikeMessageEl.textContent = "All Targets Eliminated! Mission Success!";
                strikeMessageEl.style.display = 'block';
                clearTimeout(strikeAnimationData.strikeMessageTimeout); 
                 setTimeout(() => {
                    strikeMessageEl.style.display = 'none';
                    nextButton.disabled = false;
                    nextButton.textContent = "View Aftermath";
                }, 2500);
                strikeAnimationData.phase = 'idle_completed'; // Use new phase to prevent re-triggering
            }
        }


        function animate(time) {
            requestAnimationFrame(animate);
            
            const currentSceneData = scenesData[currentSceneIndex];
            if (currentSceneData && currentSceneData.animate) {
                currentSceneData.animate(time);
            }
            
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
